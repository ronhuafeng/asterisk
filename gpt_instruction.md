以下是基于“Gmail API + 自建后端（轮询方案）”的需求说明，去除了具体实现细节，仅保留系统应具备的功能与约束。

---

## 一、系统背景与目标

* **背景**
  需要搭建一套后端服务，定期从指定 Gmail 账号中拉取“收件箱里的未读邮件”，并依据邮件发件人、主题、正文等内容执行一系列自动化操作。例如：自动打标签、归档邮件、生成备忘录（或待办），并最终将邮件标记为已读，避免重复处理。

* **目标**

  * 实现一个可靠的轮询机制，定期扫描 Gmail 收件箱中的新邮件。
  * 在符合预定义规则时，自动对邮件打标签、归档；依据邮件内容生成对应的备忘录/待办记录。
  * 确保 OAuth2 授权流程可复用，能自动刷新过期凭证；对 Token 失效、调用配额等情况做必要提示与报警。
  * 具备基本的错误处理与日志记录能力，能够在部署环境中稳定运行。

---

## 二、功能需求

以下需求描述从用户或系统角度出发，不涉及具体技术实现。

### 2.1 登录与授权

1. **OAuth2 授权入口**

   * 系统应提供一个 URL，用于引导管理员或授权用户完成 Google OAuth2 授权。
   * 完成授权后，系统必须安全地保存 `access_token`、`refresh_token` 等凭证信息，并且能够在后续自动刷新过期的访问令牌。

2. **授权凭证管理**

   * 授权凭证（包括 Refresh Token、Access Token、过期时间等）应保存在后端可访问的安全存储中（文件或数据库）。
   * 在 Token 过期或被撤销时，系统需检测并记录日志，触发一个“重新授权”提醒或邮件告警。

### 2.2 轮询扫描

1. **定时任务调度**

   * 系统应每隔可配置的时间间隔（如默认 1 分钟）触发一次扫描流程，用于检测是否有新的“未读”邮件。
   * 时间间隔应可通过配置项进行修改，例如允许设置为 1～5 分钟等。

2. **筛选未读邮件**

   * 在每次轮询中，只扫描“收件箱”里标记为“未读”的邮件，不重复处理已读邮件。
   * 若本次轮询未检索到任何未读邮件，应在日志中记录“当前无未读邮件”。

### 2.3 邮件内容解析与规则判断

1. **提取邮件元数据**

   * 每封邮件需提取以下关键信息：

     * 发件人地址（From）
     * 邮件主题（Subject）
     * 发送时间（Date）
     * 邮件正文的纯文本内容（或必要时截取摘要）

2. **自定义判断规则**

   * 系统需支持配置或内置若干规则，用于判断邮件是否符合某种操作条件。常见规则示例（仅供参考）：

     1. **发件人规则**：

        * 如果发件人为特定地址（如 [boss@example.com](mailto:boss@example.com)），则打“VIP”标签并归档。
     2. **主题关键词规则**：

        * 例如，如果主题包含“发票”或“报销”，则标记为“财务”或“报销”标签并归档。
     3. **正文关键词规则**：

        * 如果正文包含“提醒”、“待办”关键字，则生成一条备忘录或待办任务。

     * 规则能够通过正则匹配、关键字匹配等方式进行判定。
   * 业务方可以自行扩展或修改判断条件，但系统应提供一种简单的途径来维护这些规则（例如配置文件或数据库表）。

3. **避免重复处理**

   * 若某封邮件在本轮已被标记处理，则不应在下次轮询中再次进行同样操作。通常通过“处理后标记为已读”来实现。

### 2.4 自动操作

对于每封符合条件的邮件，系统需执行以下操作之一或若干：

1. **打标签（Label）**

   * 如果规则要求给邮件添加自定义标签（如“VIP”、“财务”、“HR”等）：

     * 先检查该标签是否已存在，若不存在则创建一个新标签。
     * 将该标签添加到对应邮件上。

2. **归档操作（Archive）**

   * 若规则要求将邮件归档，则需将邮件移出“收件箱”标签，使其不再出现在 Inbox 列表中。

3. **标记状态**

   * 必要时，可以对邮件执行以下状态更新：

     * 标记已读（避免下次重复扫描）
     * 标记星标或标为重要（可选）
     * 标记删除或进入垃圾箱（如遇到垃圾邮件规则）

4. **生成备忘录/待办（Memo/Task）**

   * 如果规则触发生成备忘录：

     * 系统应从邮件中提取摘要信息（如发件人、主题、正文片段），并以这些信息创建一条备忘录或待办记录。
     * 备忘录可支持多种后端存储方式：

       1. **Google Tasks**：将任务插入到用户的默认任务列表中；
       2. **自建数据库**：将任务记录写入后端数据库表，提供独立的待办列表接口供前端查询；
       3. **第三方服务**：通过调用外部 API（如 Todoist、Notion 等）创建任务。
     * 生成备忘录后，系统需记录该操作结果（成功/失败）并产生日志。

### 2.5 日志与错误处理

1. **日志记录**

   * 系统应对以下关键流程进行日志输出：

     * 每次轮询开始与结束时间、是否检测到新邮件；
     * 每封邮件被处理前后的状态（是否打标签、是否归档、是否生成备忘录、是否标为已读）；
     * 任何异常或 API 调用失败的信息。
   * 日志应包含时间戳，便于后续问题追踪。

2. **错误监控与告警**

   * 当 API 调用因凭证失效、配额超限或网络异常等原因失败时，系统应：

     * 捕获对应异常并在日志中记录错误细节；
     * 如果是 Token 失效或刷新失败，应标记该账号需要重新授权，并发送告警（例如通过邮件或其他监控渠道）；
     * 如果检测到 Gmail API 调用配额即将耗尽，应记录并可选触发告警，提示运维人员调整配额或降低轮询频率。

### 2.6 配置与可扩展性

1. **轮询间隔配置**

   * 轮询间隔应可配置（例如通过环境变量或配置文件），方便根据业务需求调整扫描频率。

2. **规则配置**

   * 邮件处理规则（发件人白名单、主题关键字、正文关键字等）应集中在一个可维护的位置（如纯文本配置文件或数据库表），方便后续扩展与修改。

3. **多用户支持（扩展）**

   * 初版仅支持单一 Gmail 账号，可通过将凭证信息（Refresh Token、Access Token）分用户存储于数据库，实现多账号并行轮询。
   * 对于多用户场景，需要在轮询时依次遍历所有已授权的用户，各自执行相同的拉取与处理逻辑，并为每个用户单独管理其 OAuth 凭证及标签命名空间。

---

## 三、非功能需求

1. **可靠性**

   * 系统应具备基本的容错能力：针对单次 API 调用失败应进行重试或记录告警，避免因为一次异常导致整个轮询停滞。
   * 在 Token 过期或被撤销时，应及时发现并提醒管理员或用户重新授权。

2. **安全性**

   * OAuth2 凭证（尤其是 Refresh Token）必须安全存储，不得明文暴露在代码仓库中。
   * 系统对外接口（如 OAuth 回调地址）需使用 HTTPS，避免中间人攻击。
   * 日志中不得泄露敏感信息（如完整的 `access_token`、邮件正文敏感片段）。

3. **可维护性**

   * 轮询间隔、规则匹配关键词、标签名称等应通过配置项进行管理，避免硬编码在程序内部。
   * 日志格式需统一、可读性强，并保留适当的异常堆栈信息，便于排查。
   * 代码或服务应易于拆分成模块，例如“Gmail API 调用模块”、“规则引擎模块”、“备忘录创建模块”等。

4. **可扩展性**

   * 后端应设计为可替换或扩展“备忘录生成”方式，支持新增更多第三方服务对接；
   * 若后续需要改为“Push+Pub/Sub”机制，以提高实时性，应保留轮询与 Push 两套接口共存的可能性。

5. **性能与配额控制**

   * 轮询频率默认设置为 1 分钟一次；若邮件量很大或用户数量增加，应考虑将轮询间隔适当放宽（如 5 分钟或 10 分钟）。
   * 依赖 Gmail API 的配额限制，应在错误处理中检测“Quota exceeded”并采取降频或限流措施。
   * 系统应支持并发处理多封邮件，但并发控制需避免瞬时过多请求导致配额快速耗尽。

---

## 四、系统组件与流程概览

以下仅做功能层面的简要说明，帮助理解系统整体架构。

1. **授权组件（Auth Service）**

   * 提供 OAuth2 授权入口与回调处理，获取并保存用户的 Token 信息。
   * 负责 Token 的自动刷新、失效检测。

2. **轮询调度组件（Scheduler）**

   * 基于可配置的时间间隔，定时触发“邮件扫描与处理”流程。
   * 支持单账号模式和多账号模式（可选），通过数据库或本地文件加载所有已授权的账号信息。

3. **Gmail 访问组件（Gmail Client）**

   * 封装与 Gmail API 的交互，用于：

     1. 列出“收件箱中未读邮件”列表；
     2. 获取单封邮件的完整信息（Headers、Body）；
     3. 对邮件执行“添加标签”、“移除标签”、“修改已读状态”等操作；
     4. （可扩展）调用 Gmail API 创建或查询标签。

4. **规则引擎组件（Rule Engine）**

   * 以配置方式维护多条“邮件匹配规则”，如发件人白名单、主题关键词、正文关键词等。
   * 每次获取到一封邮件后，将邮件元数据（发件人、主题、正文）传递给规则引擎，返回“该邮件需要执行哪些操作”这一判定结果。

5. **自动操作组件（Action Executor）**

   * 根据规则引擎的判定，调用 Gmail Client 进行相应操作（打标签、归档、标记已读等）。
   * 若需生成备忘录，还要调用“备忘录存储组件”或调用第三方 API。

6. **备忘录存储组件（Memo Service）**

   * 将符合条件的邮件信息（如发件人、主题、正文摘要、时间戳）封装成一条备忘录/待办记录，存入指定后端：

     * **Google Tasks**：通过 Tasks API 插入；
     * **自建数据库**：插入到自定义的 `memos` 表；
     * **第三方待办平台**：按照其 RESTful 接口格式请求。

7. **日志与监控组件（Logging & Monitoring）**

   * 负责将重要流程与异常信息写入统一日志（本地文件或集中式日志系统）。
   * 监控 Token 失效、API 调用失败、配额过限等异常情况，并触发相应告警。

---

## 五、验收标准

1. **授权流程正确性**

   * 在首次运行时，能正确生成 OAuth2 授权链接并引导用户访问；
   * 用户同意授权后，系统能拿到 `access_token`、`refresh_token`，并将凭证持久化；
   * 重启服务后可直接读取凭证并跳过重复授权。

2. **轮询扫描稳定性**

   * 服务启动后能按配置的轮询间隔定期执行“拉取未读邮件”操作；
   * 如果收件箱中没有未读邮件，轮询任务应不报错，仅在日志中记录“无新邮件”；
   * 如果收到新邮件，能正确提取元数据并进入后续处理流程。

3. **规则判断与自动操作准确性**

   * 针对“发件人为 [boss@example.com](mailto:boss@example.com)” 的邮件，应当：

     1. 添加“VIP”标签（如果标签不存在则先创建）；
     2. 移除 INBOX 标签（归档）；
     3. 将邮件标记为已读。
   * 针对正文含有“提醒”关键字的邮件，应当：

     1. 在备忘录服务中创建一条记录；
     2. 将邮件标记为已读；
     3. 如果规则中另有标签需求，也同时满足打标签或归档。
   * 当多个规则同时命中时，应能将所有对应操作合并执行（例如：既打标签又生成备忘录）。

4. **备忘录（待办）生成有效性**

   * 生成 Google Tasks 或插入数据库时，各字段（标题、内容摘要、发件人、时间）应正确无误；
   * 若使用第三方待办平台，接口请求应成功并在相应平台上能看到新建的任务。

5. **错误与告警机制**

   * 在 OAuth2 Token 过期或被撤销时，轮询过程中应检测到授权失败并在日志中记录，同时对外输出“需要重新授权”提示；
   * 在 Gmail API 配额用尽或网络异常时，能记录错误堆栈，且在连续失败达到一定阈值时触发告警。
   * 当生成备忘录失败时，错误信息应写入日志，且不会影响对其他邮件的处理。

6. **可配置性与扩展性**

   * 可以通过简单修改配置项（如 JSON、YAML 或环境变量）来：

     * 调整轮询间隔；
     * 增删邮件匹配规则；
     * 配置备忘录存储方式（Google Tasks／本地数据库／第三方服务）。
   * 当需要新增规则或改变已有规则时，无需修改核心轮询框架代码；只需更新规则配置即可生效。

7. **部署与运维可用性**

   * 系统能在 Linux 服务器或容器环境中正常运行，通过 `npm start`（或等价命令）即可启动；
   * 日志可按天或按文件大小轮转，不会无限制增长；
   * 当服务意外崩溃或重启时，能够自动恢复轮询任务，恢复后无遗漏地继续从上次状态开始扫描。

---

## 六、小结

此版需求文档已将“Gmail API + 自建后端（轮询）”的完整实现思路拆解为：

1. **系统需要的功能模块及其职责**
2. **各功能模块应满足的业务/技术需求**
3. **对关键流程（授权、轮询、规则判断、自动操作、日志告警等）的验收标准**

后续可在此基础上补充更详细的 UI 需求（若需提供前端查看备忘录列表）、安全策略（如加密存储凭证）、监控告警方案（如对接第三方告警平台）等。这样既能保证项目按需求落地，也方便后续团队分工与维护。
